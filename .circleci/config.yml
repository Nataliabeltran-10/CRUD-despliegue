version: 2.1

jobs:
  test:
    docker:
      - image: circleci/node:16  
    working_directory: ~/repo  
    steps:
      - checkout  
      - run:
          name: Instalar dependencias
          command: npm install  
      - run:
          name: Instalar Jest globalmente
          command: sudo npm install -g jest  
      - run:
          name: Verificar instalación de Jest
          command: npx jest --version  
      - run:
          name: Ejecutar pruebas
          command: npm test 

  delivery:
    docker:
      - image: circleci/node:16
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Notificar sobre el estado del build
          command: echo "Las pruebas han pasado. Listo para entrega."
      - run:
          name: Enviar notificación (Slack, Email, etc.)
          command: |
            if [ -n "$SLACK_WEBHOOK_URL" ]; then
              curl -X POST -H 'Content-type: application/json' --data '{"text":"El build está listo para ser desplegado."}' "$SLACK_WEBHOOK_URL"
            else
              echo "SLACK_WEBHOOK_URL no está definido, omitiendo notificación."
            fi

  deploy:
    docker:
      - image: circleci/node:16
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Validar variables de entorno
          command: |
            if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_IMAGE_NAME" ]; then
              echo "ERROR: DOCKER_USERNAME o DOCKER_IMAGE_NAME no están definidos"
              exit 1
            fi
      - run:
          name: Construir imagen Docker
          command: docker build -t $DOCKER_USERNAME/$DOCKER_IMAGE_NAME:latest .
      - run:
          name: Iniciar sesión en Docker Hub
          command: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Subir imagen a Docker Hub
          command: docker push $DOCKER_USERNAME/$DOCKER_IMAGE_NAME:latest
      - run:
          name: Desplegar en el servidor
          command: |
            ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "docker pull $DOCKER_USERNAME/$DOCKER_IMAGE_NAME:latest && docker stop app || true && docker rm app || true && docker run -d --name app -p 80:3000 $DOCKER_USERNAME/$DOCKER_IMAGE_NAME:latest"

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - test
      - delivery:
          requires:
            - test
      - deploy:
          requires:
            - delivery
